# Hardhat Testnet Node

Локальная блокчейн-нода на базе Hardhat для разработки и тестирования системы QR-платежей.

## Описание

Hardhat-нода предоставляет локальную тестовую блокчейн-сеть для разработки и тестирования. Включает:

- **Локальную Ethereum-совместимую сеть** с быстрым майнингом
- **Предустановленные тестовые аккаунты** с балансами
- **Готовые смарт-контракты** для платежей
- **Docker-контейнеризацию** для интеграции с другими сервисами
- **Health check** для мониторинга состояния

## Технологический стек

- **Hardhat** - фреймворк для разработки блокчейн-приложений
- **Solidity 0.8.28** - язык смарт-контрактов
- **Ethers.js** - библиотека для взаимодействия с блокчейном
- **Docker** - контейнеризация
- **Node.js 22** - среда выполнения

## Архитектура

```tree
contracts/
├── Wallet.sol         # Контракт для приема платежей
├── TestContract.sol   # Тестовый контракт
└── Lock.sol          # Пример контракта Hardhat

scripts/
├── deploy.js         # Скрипт деплоя контрактов
├── start-node.ps1    # PowerShell скрипт запуска
└── stop-node.ps1     # PowerShell скрипт остановки

artifacts/            # Скомпилированные контракты
cache/               # Кэш компиляции
test/                # Тесты контрактов
```

## Смарт-контракты

### Wallet.sol

Основной контракт для обработки платежей:

- **`payForItem()`** - прием платежей от пользователей
- **`withdrawAll()`** - вывод всех средств владельцем
- **`payments`** - маппинг платежей по адресам
- **События** - логирование платежей и выводов

### TestContract.sol

Тестовый контракт для проверки функциональности:

- **`setValue()`** - установка значения
- **`getValue()`** - получение значения
- **`getOwner()`** - получение владельца

## Сетевая конфигурация

| Параметр | Значение |
|----------|----------|
| **RPC URL** | `http://localhost:8545` |
| **Chain ID** | `1337` |
| **Сеть** | `qrb-network` (Docker) |
| **Майнинг** | Автоматический (1 сек) |
| **Аккаунты** | 20 тестовых |

## Тестовые аккаунты

Нода создает 20 предустановленных аккаунтов с балансами:

| Аккаунт | Адрес | Приватный ключ | Баланс |
|---------|-------|----------------|---------|
| #0 | `0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266` | `0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80` | 10000 ETH |
| #1 | `0x70997970C51812dc3A010C7d01b50e0d17dc79C8` | `0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d` | 10000 ETH |
| #2 | `0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC` | `0x5de4111daa5ba4e0b23975c70d90abd0921ef9c4b4b69759b17e0368b8d871d0` | 10000 ETH |

## Установка и запуск

### Локальная разработка

1. **Установка зависимостей:**

```bash
npm install
```

2. **Компиляция контрактов:**

```bash
npm run compile
```

3. **Запуск ноды:**

```bash
npm run node
```

4. **Деплой контрактов (в отдельном терминале):**

```bash
npm run deploy
```

### Docker

1. **Создание сети:**

```bash
docker network create qrb-network
```

2. **Запуск через PowerShell:**

```powershell
.\scripts\start-node.ps1
```

3. **Остановка:**

```powershell
.\scripts\stop-node.ps1
```

### Docker Compose

```bash
# Запуск
docker-compose up --build -d

# Остановка
docker-compose down

# Просмотр логов
docker-compose logs -f
```

## Доступные команды

| Команда | Описание |
|---------|----------|
| `npm run compile` | Компиляция смарт-контрактов |
| `npm run node` | Запуск локальной ноды |
| `npm run deploy` | Деплой контрактов на localhost |
| `npm run start` | Запуск ноды (alias для node) |

## Мониторинг и диагностика

### Health Check

Нода включает автоматический health check каждые 30 секунд:

```bash
curl -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  http://localhost:8545
```

### Проверка статуса контейнера

```bash
docker-compose ps
```

### Просмотр логов

```bash
docker-compose logs -f hardhat-node
```

## Интеграция с другими сервисами

### Подключение из бэкенда

```javascript
const networkRpcUrl = "http://hardhat-node:8545"; // В Docker сети
// или
const networkRpcUrl = "http://localhost:8545";    // Локально
```

### Переменные окружения

- `NETWORK_RPC_URL=http://hardhat-node:8545` (Docker)
- `NETWORK_RPC_URL=http://localhost:8545` (локально)
- `BLOCKCHAIN_CONFIRMATIONS=3`

## Разработка

### Добавление новых контрактов

1. Создайте файл в `contracts/`
2. Скомпилируйте: `npm run compile`
3. Создайте скрипт деплоя в `scripts/`
4. Задеплойте: `npm run deploy`

### Тестирование

```bash
# Запуск тестов (если есть)
npm test

# Проверка контракта вручную
npm run deploy
```

### Структура проекта

- **`/contracts`** - исходный код смарт-контрактов
- **`/scripts`** - скрипты деплоя и управления
- **`/test`** - тесты контрактов
- **`/artifacts`** - скомпилированные контракты
- **`/cache`** - кэш компиляции Hardhat

## Troubleshooting

### Проблемы с запуском ноды

1. Убедитесь, что порт 8545 свободен
2. Проверьте, что Docker запущен
3. Проверьте логи: `docker-compose logs`

### Проблемы с подключением

1. Убедитесь, что нода запущена: `curl http://localhost:8545`
2. Проверьте Chain ID: должен быть 1337
3. Убедитесь, что используете правильный RPC URL

### Проблемы с контрактами

1. Перекомпилируйте: `npm run compile`
2. Проверьте версию Solidity в контрактах
3. Убедитесь, что контракты задеплоены: `npm run deploy`
